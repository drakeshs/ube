// ube core library v1.0
// == javascript image processing
// Ian Farrell

(function(i,a,n){var c=i.ube,j=function(k,l){return j.load(k,function(){l&&l.call(this);if(k.parentElement){k.parentElement.replaceChild(this.canvas,k)}})},Z=function(){this.backref=j},h=function(k,l){for(property in l){k[property]=l[property]}return k},b=function(k,l){return h(new i.Image(),{onload:function(){l&&l(this)},src:k})},f=function(l){var k=e(l.width,l.height);k.getContext('2d').drawImage(l,0,0);return k},e=function(l,k){return h(a.createElement('canvas'),{width:l,height:k})};h(j,{load:function(m,n){var l=new Z();if(typeof m==='string'){b(m,function(o){l.canvas=f(o);n&&n.call(l,l)})}else{if(m.src){l.canvas=f(m)}else{if(m.getContext){l.canvas=m}else{if(m.length){for(var k=0,l=[];k<m.length;k++){l[k]=this.load(m[k],n)}}}}}if(!m.length&&typeof m!='string'&&n){n.call(l,l)}return l},filters:{},addFilters:function(k){for(filter in k){this.filters[filter]=k[filter];Z.prototype[filter]=(function(l){return function(){this.renderQueue.push([l,Array.prototype.slice.call(arguments,0)]);return this}})(filter)}},noConflict:function(){i.ube=c;return j},version:'1.0'});h(Z.prototype,{width:function(){return this.canvas.width},height:function(){return this.canvas.height},dataURL:function(){return this.canvas.toDataURL()},ctx:function(){return this.canvas.getContext('2d')},createImageData:function(l,k){return this.ctx().createImageData(l||this.width(),k||this.height())},getImageData:function(l,n,m,k){if(arguments.length===0&&this.cachedImageData){return this.cachedImageData}else{return this.ctx().getImageData(l||0,n||0,m||this.width(),k||this.height())}},putImageData:function(m,k,l){return this.ctx().putImageData(m,k||0,l||0)},copyImageData:function(l){var k=j.load(e(l.width,l.height),function(m){m.putImageData(l)});return k.getImageData()},cacheImageData:function(k){this.cachedImageData=k},processImageData:function(p,n){var o=p.data;for(var m=0;m<n.length;m++){var l=n[m][0],k=n[m][1];if(j.filters[l]){value=j.filters[l](o,k,p,this);value&&(p=value,o=p.data)}}p.data=o;return p},renderQueue:[],apply:function(){var k=this.getImageData();k=this.processImageData(k,this.renderQueue);this.putImageData(k);this.cacheImageData(k);this.renderQueue=[];return this},draw:function(l){if(typeof l==='function'){l(this.ctx())}else{var k=this.ctx();for(O in l){if(typeof k[O]==='function'){k[O].apply(k,l[O])}else{k[O]=l[O]}}}return this},applyRect:function(l,o,m,k){var n=this.getImageData(l,o,m,k);n=this.processImageData(n,this.renderQueue);this.putImageData(n,l,o);this.cacheImageData();this.renderQueue=[];return this},applyCustom:function(z,k){var p=e(this.width(),this.height()),A=j.load(p,function(x){x.draw(z)}),o=A.getImageData(),m=o.data,q=[];for(var C=0,D=m.length;C<D;C+=4){if(m[C+3]>0){var t=(C/4)%o.width,s=Math.floor(C/(o.width*4));if((t<q[0])||(q[0]===n)){q[0]=t}if(q[1]===n){q[1]=s}if((t>q[2])||(q[2]===n)){q[2]=t}if((s>q[3])||(q[3]===n)){q[3]=s}}}q[2]-=q[0]-1;q[3]-=q[1]-1,o=A.getImageData.apply(A,q),v=this.getImageData.apply(this,q),l=this.copyImageData(v),n=this.processImageData(l,this.renderQueue),m=o.data,w=v.data,u=n.data;for(var C=0,D=w.length;C<D;C+=4){if(m[C+3]!=0){var r=(k)?(m[C+3]/255):0.5;for(var B=0;B++<4;){w[C+B]=(k)?((u[C+B]*r)+(w[C+B]*(1-r))):u[C+B]}}}v.data=w;this.putImageData(v,q[0],q[1]);this.cacheImageData();this.renderQueue=[];return this},});return(i.ube=j)})(this,document);
